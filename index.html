<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FRC Fluxogramas ‚Äî Sistema de Processos</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîÑ</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<style>
/* ============================================================
   CSS VARIABLES
   ============================================================ */
:root {
  --bg: #06090f;
  --surface: #0d1321;
  --surface2: #151d2e;
  --surface3: #1c2940;
  --border: #243049;
  --border-h: #3a506b;
  --text: #eaf0f6;
  --text2: #8899b0;
  --text3: #56687d;
  --blue: #4d8df7;
  --blue-g: rgba(77,141,247,0.1);
  --green: #2dd4a0;
  --green-g: rgba(45,212,160,0.1);
  --yellow: #f0b429;
  --yellow-g: rgba(240,180,41,0.1);
  --red: #f05252;
  --red-g: rgba(240,82,82,0.1);
  --orange: #fb923c;
  --orange-g: rgba(251,146,60,0.1);
  --purple: #a78bfa;
  --purple-g: rgba(167,139,250,0.1);
  --cyan: #22d3ee;
  --cyan-g: rgba(34,211,238,0.1);
  --pink: #f472b6;
  --pink-g: rgba(244,114,182,0.1);
  --frc-red: #d42027;
  --radius: 12px;
  --radius-lg: 16px;
  --mono: 'JetBrains Mono', monospace;
  --sans: 'DM Sans', sans-serif;
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
  --shadow-lg: 0 12px 48px rgba(0,0,0,0.4);
}

* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: var(--sans); background: var(--bg); color: var(--text); min-height:100vh; }
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* ============================================================
   LOGIN SCREEN
   ============================================================ */
#loginScreen {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 24px;
  background: radial-gradient(ellipse at 30% 20%, rgba(77,141,247,0.06) 0%, transparent 60%),
              radial-gradient(ellipse at 70% 80%, rgba(212,32,39,0.04) 0%, transparent 60%),
              var(--bg);
}

.login-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 48px 40px;
  max-width: 420px;
  width: 100%;
  box-shadow: var(--shadow-lg);
  text-align: center;
}

.login-logo {
  font-family: var(--mono);
  font-size: 1.4rem;
  font-weight: 800;
  color: var(--frc-red);
  letter-spacing: -1px;
  margin-bottom: 4px;
}

.login-sub {
  font-size: 0.78rem;
  color: var(--text3);
  margin-bottom: 32px;
}

.login-box h2 {
  font-size: 1.15rem;
  margin-bottom: 24px;
  font-weight: 700;
}

.input-group {
  text-align: left;
  margin-bottom: 16px;
}

.input-group label {
  display: block;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text2);
  margin-bottom: 6px;
}

.input-group input, .input-group select {
  width: 100%;
  font-family: var(--sans);
  font-size: 0.88rem;
  padding: 11px 16px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--surface2);
  color: var(--text);
  outline: none;
  transition: border-color 0.2s;
}

.input-group input:focus, .input-group select:focus {
  border-color: var(--blue);
}

.login-btn {
  width: 100%;
  font-family: var(--sans);
  font-size: 0.9rem;
  font-weight: 700;
  padding: 12px;
  border-radius: 10px;
  border: none;
  background: var(--blue);
  color: white;
  cursor: pointer;
  margin-top: 8px;
  transition: all 0.2s;
}

.login-btn:hover { background: #3a7ae6; transform: translateY(-1px); }

.login-error {
  color: var(--red);
  font-size: 0.78rem;
  margin-top: 12px;
  display: none;
}

.login-hint {
  font-size: 0.7rem;
  color: var(--text3);
  margin-top: 20px;
  line-height: 1.5;
}

/* ============================================================
   APP LAYOUT
   ============================================================ */
#appScreen { display: none; }

.topbar {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(6,9,15,0.88);
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  border-bottom: 1px solid var(--border);
  padding: 10px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.topbar-left { display: flex; align-items: center; gap: 14px; }

.tb-logo {
  font-family: var(--mono);
  font-weight: 800;
  font-size: 0.8rem;
  color: var(--frc-red);
  letter-spacing: -0.5px;
  border-right: 1px solid var(--border);
  padding-right: 14px;
}

.breadcrumb { display: flex; align-items: center; gap: 5px; font-size: 0.78rem; color: var(--text3); }
.breadcrumb span { cursor: pointer; transition: color 0.15s; }
.breadcrumb span:hover { color: var(--blue); }
.breadcrumb .sep { font-size: 0.65rem; }
.breadcrumb .cur { color: var(--text); font-weight: 600; }

.topbar-right { display: flex; align-items: center; gap: 8px; }

.user-badge {
  font-size: 0.7rem;
  font-weight: 600;
  padding: 5px 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface2);
  color: var(--text2);
}

.user-badge.ceo { border-color: rgba(212,32,39,0.4); color: var(--frc-red); background: rgba(212,32,39,0.08); }

.btn-logout {
  font-family: var(--sans);
  font-size: 0.7rem;
  padding: 5px 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text3);
  cursor: pointer;
  transition: all 0.15s;
}

.btn-logout:hover { border-color: var(--red); color: var(--red); }

/* Sector tabs */
.sector-tabs {
  padding: 10px 20px;
  display: flex;
  gap: 5px;
  overflow-x: auto;
  border-bottom: 1px solid var(--border);
  scrollbar-width: none;
}
.sector-tabs::-webkit-scrollbar { display: none; }

.stab {
  font-family: var(--sans);
  font-size: 0.7rem;
  font-weight: 600;
  padding: 5px 13px;
  border-radius: 7px;
  border: 1px solid transparent;
  background: transparent;
  color: var(--text3);
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.15s;
}

.stab:hover { background: var(--surface2); color: var(--text2); }
.stab.active { background: var(--blue-g); border-color: rgba(77,141,247,0.25); color: var(--blue); }
.stab.locked { opacity: 0.4; cursor: not-allowed; }

.main { padding: 20px; max-width: 1300px; margin: 0 auto; }

/* ============================================================
   TOOLBAR
   ============================================================ */
.toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.toolbar-left h1 { font-size: 1.4rem; font-weight: 800; }
.toolbar-left p { font-size: 0.82rem; color: var(--text2); margin-top: 2px; }

.toolbar-right { display: flex; gap: 8px; flex-wrap: wrap; }

.tbtn {
  font-family: var(--sans);
  font-size: 0.75rem;
  font-weight: 600;
  padding: 7px 16px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text2);
  cursor: pointer;
  transition: all 0.15s;
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

.tbtn:hover { border-color: var(--border-h); color: var(--text); }
.tbtn.primary { border-color: var(--green); background: var(--green-g); color: var(--green); }
.tbtn.primary:hover { background: var(--green); color: white; }
.tbtn.danger { border-color: var(--red); background: var(--red-g); color: var(--red); }
.tbtn.active { background: var(--blue-g); border-color: rgba(77,141,247,0.3); color: var(--blue); }

/* ============================================================
   STATS ROW
   ============================================================ */
.stats-row { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }

.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 18px;
  min-width: 120px;
  flex: 1;
}

.stat-card .sl { font-family: var(--mono); font-size: 0.6rem; letter-spacing: 1px; text-transform: uppercase; color: var(--text3); margin-bottom: 3px; }
.stat-card .sv { font-size: 1.3rem; font-weight: 800; }

/* ============================================================
   LEGEND
   ============================================================ */
.legend {
  display: flex;
  flex-wrap: wrap;
  gap: 14px;
  padding: 12px 18px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  margin-bottom: 20px;
}

.leg { display: flex; align-items: center; gap: 6px; font-size: 0.7rem; color: var(--text2); }
.leg-d { width: 10px; height: 10px; border-radius: 3px; border: 2px solid; flex-shrink: 0; }

/* ============================================================
   MACRO FLOW
   ============================================================ */
.macro-flow {
  display: flex;
  align-items: flex-start;
  gap: 0;
  overflow-x: auto;
  padding: 16px 0 28px;
}

.mblock {
  min-width: 195px;
  max-width: 215px;
  flex-shrink: 0;
  cursor: pointer;
  transition: all 0.2s;
  animation: fadeUp 0.35s ease-out both;
}

.mblock:hover { transform: translateY(-3px); }

.mcard {
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  padding: 18px;
  position: relative;
  transition: all 0.2s;
}

.mblock:hover .mcard { border-color: var(--blue); box-shadow: 0 6px 24px rgba(77,141,247,0.12); }

.mcard .mnum {
  font-family: var(--mono);
  font-size: 0.6rem;
  font-weight: 700;
  letter-spacing: 0.8px;
  display: inline-block;
  padding: 2px 8px;
  border-radius: 5px;
  margin-bottom: 8px;
}

.mcard .mcount {
  position: absolute;
  top: 10px;
  right: 10px;
  font-family: var(--mono);
  font-size: 0.58rem;
  color: var(--text3);
  background: var(--surface2);
  padding: 2px 7px;
  border-radius: 5px;
}

.mcard h3 { font-size: 0.85rem; font-weight: 700; margin-bottom: 5px; line-height: 1.25; }
.mcard .mdesc { font-size: 0.72rem; color: var(--text2); line-height: 1.4; margin-bottom: 10px; }

.mcard .mtags { display: flex; flex-wrap: wrap; gap: 4px; }
.mtag { font-family: var(--mono); font-size: 0.58rem; padding: 2px 7px; border-radius: 5px; font-weight: 500; }

.mcard .mhint {
  margin-top: 10px;
  font-size: 0.65rem;
  color: var(--blue);
  font-weight: 600;
  opacity: 0;
  transition: opacity 0.15s;
}
.mblock:hover .mhint { opacity: 1; }

.marrow {
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 36px;
  flex-shrink: 0;
  color: var(--text3);
  font-size: 1.1rem;
  padding-top: 28px;
}

.add-card {
  background: var(--surface);
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  padding: 36px 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 16px;
}

.add-card:hover { border-color: var(--blue); background: var(--blue-g); }
.add-card .ai { font-size: 1.6rem; margin-bottom: 6px; }
.add-card p { font-size: 0.8rem; color: var(--text3); }

/* ============================================================
   MICRO VIEW
   ============================================================ */
.micro-back {
  font-family: var(--sans);
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--blue);
  background: var(--blue-g);
  border: 1px solid rgba(77,141,247,0.25);
  padding: 7px 16px;
  border-radius: 8px;
  cursor: pointer;
  margin-bottom: 16px;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  transition: all 0.15s;
}

.micro-back:hover { background: var(--blue); color: white; }

.micro-head {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 12px;
}

.micro-head h2 { font-size: 1.2rem; font-weight: 700; }
.micro-head .msub { color: var(--text2); font-size: 0.82rem; margin-top: 3px; }

/* Micro flow vertical */
.micro-flow { position: relative; display: flex; flex-direction: column; max-width: 780px; }

.mstep {
  display: grid;
  grid-template-columns: 48px 1fr;
  gap: 14px;
  position: relative;
  animation: fadeUp 0.3s ease-out both;
}

.mtimeline { display: flex; flex-direction: column; align-items: center; }

.mdot {
  width: 38px;
  height: 38px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--mono);
  font-size: 0.7rem;
  font-weight: 700;
  flex-shrink: 0;
  z-index: 2;
}

.mdot.action { background: var(--blue-g); border: 2px solid var(--blue); color: var(--blue); }
.mdot.decision { background: var(--yellow-g); border: 2px solid var(--yellow); color: var(--yellow); border-radius: 50%; }
.mdot.end-ok { background: var(--green-g); border: 2px solid var(--green); color: var(--green); }
.mdot.end-fail { background: var(--red-g); border: 2px solid var(--red); color: var(--red); }
.mdot.subprocess { background: var(--purple-g); border: 2px solid var(--purple); color: var(--purple); }
.mdot.wait { background: var(--orange-g); border: 2px solid var(--orange); color: var(--orange); }

.mline { width: 2px; flex: 1; min-height: 14px; background: var(--border); }

.scard {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px 20px;
  margin-bottom: 8px;
  transition: all 0.15s;
  position: relative;
}

.scard:hover { border-color: rgba(77,141,247,0.25); }

.scard h4 { font-size: 0.88rem; font-weight: 700; margin-bottom: 4px; }
.scard .sd { font-size: 0.78rem; color: var(--text2); line-height: 1.5; margin-bottom: 8px; }

.scard .stags { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; }
.stg { font-family: var(--mono); font-size: 0.58rem; padding: 2px 8px; border-radius: 5px; font-weight: 600; }
.stg.resp { background: var(--cyan-g); color: var(--cyan); }
.stg.prazo { background: var(--yellow-g); color: var(--yellow); }
.stg.sistema { background: var(--purple-g); color: var(--purple); }
.stg.meta { background: var(--green-g); color: var(--green); }
.stg.penal { background: var(--red-g); color: var(--red); }

.branches { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 6px; }
.bbx { padding: 10px 12px; border-radius: 9px; border: 1px solid; }
.bbx.yes { background: var(--green-g); border-color: rgba(45,212,160,0.2); }
.bbx.no { background: var(--red-g); border-color: rgba(240,82,82,0.2); }
.bbx .blbl { font-family: var(--mono); font-size: 0.62rem; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 3px; }
.bbx.yes .blbl { color: var(--green); }
.bbx.no .blbl { color: var(--red); }
.bbx p { font-size: 0.72rem; color: var(--text2); line-height: 1.35; }

.penalty-section {
  background: var(--red-g);
  border: 1px solid rgba(240,82,82,0.2);
  border-radius: 10px;
  padding: 14px 16px;
  margin-top: 20px;
  max-width: 780px;
}

.penalty-section h5 { font-family: var(--mono); font-size: 0.68rem; color: var(--red); letter-spacing: 0.5px; margin-bottom: 8px; }
.penalty-section ul { list-style: none; display: flex; flex-direction: column; gap: 5px; }
.penalty-section li { font-size: 0.74rem; color: var(--text2); padding-left: 18px; position: relative; line-height: 1.4; }
.penalty-section li::before { content: '‚ö†'; position: absolute; left: 0; font-size: 0.68rem; }

/* Edit buttons on cards */
.edit-btns {
  position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  gap: 4px;
  opacity: 0;
  transition: opacity 0.15s;
}

.scard:hover .edit-btns,
.mcard:hover .edit-btns { opacity: 1; }

.ebtn {
  font-size: 0.65rem;
  padding: 3px 8px;
  border-radius: 5px;
  border: 1px solid var(--border);
  background: var(--surface2);
  color: var(--text3);
  cursor: pointer;
  font-family: var(--sans);
  transition: all 0.15s;
}

.ebtn:hover { border-color: var(--blue); color: var(--blue); }
.ebtn.del:hover { border-color: var(--red); color: var(--red); }

/* ============================================================
   MODAL
   ============================================================ */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(8px);
  z-index: 300;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-overlay.active { display: flex; }

.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 28px;
  max-width: 580px;
  width: 100%;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
}

.modal h2 { font-size: 1.1rem; margin-bottom: 18px; }

.fg { margin-bottom: 14px; }
.fg label { display: block; font-size: 0.73rem; font-weight: 600; color: var(--text2); margin-bottom: 5px; }

.fg input, .fg textarea, .fg select {
  width: 100%;
  font-family: var(--sans);
  font-size: 0.82rem;
  padding: 9px 13px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface2);
  color: var(--text);
  outline: none;
  transition: border-color 0.15s;
}

.fg input:focus, .fg textarea:focus, .fg select:focus { border-color: var(--blue); }
.fg textarea { resize: vertical; min-height: 70px; }

.fg-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

.form-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 18px; }

.btn {
  font-family: var(--sans);
  font-size: 0.8rem;
  font-weight: 600;
  padding: 8px 18px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  transition: all 0.15s;
}

.btn-cancel { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); }
.btn-save { background: var(--blue); color: white; }
.btn-save:hover { background: #3a7ae6; }
.btn-del { background: var(--red); color: white; }
.btn-del:hover { background: #d43d3d; }

/* ============================================================
   LOADING / TOAST
   ============================================================ */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  padding: 12px 20px;
  border-radius: 10px;
  font-size: 0.82rem;
  font-weight: 600;
  z-index: 400;
  animation: toastIn 0.3s ease-out;
  box-shadow: var(--shadow);
}

.toast.success { background: var(--green); color: #052e16; }
.toast.error { background: var(--red); color: white; }
.toast.info { background: var(--blue); color: white; }

@keyframes toastIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
@keyframes fadeUp { from { opacity:0; transform:translateY(14px); } to { opacity:1; transform:translateY(0); } }

.spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid var(--border);
  border-top-color: var(--blue);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* ============================================================
   EMPTY / NO-ACCESS
   ============================================================ */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text3);
}

.empty-state .ei { font-size: 2.5rem; margin-bottom: 12px; }
.empty-state h3 { font-size: 1.1rem; color: var(--text2); margin-bottom: 6px; }
.empty-state p { font-size: 0.85rem; max-width: 400px; margin: 0 auto; }

/* ============================================================
   RESPONSIVE
   ============================================================ */
@media (max-width: 768px) {
  .topbar { padding: 8px 14px; flex-wrap: wrap; }
  .main { padding: 14px; }
  .toolbar-left h1 { font-size: 1.1rem; }
  .macro-flow { flex-direction: column; align-items: stretch; }
  .mblock { max-width: 100%; min-width: 0; }
  .marrow { transform: rotate(90deg); min-width: auto; min-height: 24px; padding: 0; }
  .branches { grid-template-columns: 1fr; }
  .mstep { grid-template-columns: 36px 1fr; gap: 10px; }
  .fg-row { grid-template-columns: 1fr; }
  .login-box { padding: 32px 24px; }
}

@media print {
  #loginScreen, .topbar, .sector-tabs, .toolbar-right, .edit-btns, .add-card { display: none !important; }
  body { background: white; color: #111; }
  .mcard, .scard, .stat-card { border-color: #ddd; background: #f9f9f9; }
}
</style>
</head>
<body>

<!-- ============================================================
     LOGIN SCREEN
     ============================================================ -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">FLORIDA RENTAL CAR</div>
    <div class="login-sub">Sistema de Fluxogramas de Processos</div>
    <h2>Acessar Sistema</h2>

    <div class="input-group">
      <label>Seu nome</label>
      <input type="text" id="loginName" placeholder="Ex: Jo√£o Silva">
    </div>

    <div class="input-group">
      <label>C√≥digo de acesso</label>
      <input type="password" id="loginCode" placeholder="Digite o c√≥digo fornecido pelo CEO">
    </div>

    <button class="login-btn" onclick="doLogin()">Entrar</button>

    <div class="login-error" id="loginError"></div>

    <div class="login-hint">
      O c√≥digo de acesso √© fornecido pelo CEO.<br>
      C√≥digo CEO = acesso total a todos os setores.<br>
      C√≥digo do setor = acesso apenas ao seu setor.
    </div>
  </div>
</div>

<!-- ============================================================
     APP SCREEN
     ============================================================ -->
<div id="appScreen">
  <div class="topbar">
    <div class="topbar-left">
      <div class="tb-logo">FRC</div>
      <div class="breadcrumb" id="breadcrumb"><span class="cur">Carregando...</span></div>
    </div>
    <div class="topbar-right">
      <div class="user-badge" id="userBadge"></div>
      <button class="btn-logout" onclick="doLogout()">Sair</button>
    </div>
  </div>

  <div class="sector-tabs" id="sectorTabs"></div>

  <div class="main" id="mainContent">
    <div class="empty-state"><div class="spinner"></div><p style="margin-top:12px">Carregando dados...</p></div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modalContent"></div>
</div>

<!-- ============================================================
     JAVASCRIPT
     ============================================================ -->
<script>
/* ==============================================================
   FIREBASE CONFIG
   ==============================================================
   ‚ö†Ô∏è IMPORTANTE: Substitua o objeto abaixo pela configura√ß√£o
   do SEU projeto Firebase. Veja o guia de setup.
   ============================================================== */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCOBaTzerrtRf1FpKCDPXt5lqHqPe4vY5w",
  authDomain: "floridarentalcar-3007b.firebaseapp.com",
  projectId: "floridarentalcar-3007b",
  storageBucket: "floridarentalcar-3007b.firebasestorage.app",
  messagingSenderId: "919190214515",
  appId: "1:919190214515:web:6087c48ee5032df4ee5706"
};

/* ==============================================================
   ACCESS CODES
   ==============================================================
   Configure os c√≥digos de acesso aqui.
   O CEO tem acesso total. Cada setor tem seu pr√≥prio c√≥digo.
   ============================================================== */
const ACCESS_CODES = {
  // C√≥digo master do CEO - acesso total
  "ceo2025": { role: "ceo", name: "CEO", sectors: "all" },

  // C√≥digos por setor - cada l√≠der s√≥ acessa seu setor
  "frota2025":    { role: "lider", name: "Frota",             sectors: ["Frota"] },
  "mkt2025":      { role: "lider", name: "MKT",               sectors: ["MKT"] },
  "comercial2025":{ role: "lider", name: "Comercial",          sectors: ["Comercial"] },
  "operacional2025":{ role: "lider", name: "Operacional",      sectors: ["Operacional"] },
  "posvenda2025": { role: "lider", name: "P√≥s-venda",          sectors: ["P√≥s-venda"] },
  "suporte2025":  { role: "lider", name: "Suporte",            sectors: ["Suporte"] },
  "entrega2025":  { role: "lider", name: "Entrega/Devolu√ß√£o",  sectors: ["Entrega/Devolu√ß√£o"] },
  "cs2025":       { role: "lider", name: "CS",                 sectors: ["CS"] },
  "qualidade2025":{ role: "lider", name: "Qualidade",          sectors: ["Qualidade"] },
  "pessoas2025":  { role: "lider", name: "Pessoas/Cultura",    sectors: ["Pessoas/Cultura"] },
  "oficina2025":  { role: "lider", name: "Oficina",            sectors: ["Oficina"] },
  "update2025":   { role: "lider", name: "Update",             sectors: ["Update"] },
  "coo2025":      { role: "lider", name: "COO",                sectors: ["COO"] },
  "financeiro2025":{ role: "lider", name: "Financeiro",        sectors: ["Financeiro"] },
  "plus2025":     { role: "lider", name: "Plus",               sectors: ["Plus"] },
  "cegonha2025":  { role: "lider", name: "Cegonha",            sectors: ["Cegonha"] },
  "kommo2025":    { role: "lider", name: "Kommo",              sectors: ["Kommo"] },
  "dashboard2025":{ role: "lider", name: "Dashboard",          sectors: ["Dashboard"] },
  "dunas2025":    { role: "lider", name: "Dunas",              sectors: ["Dunas"] },
  "apn2025":      { role: "lider", name: "APN",                sectors: ["APN"] },
};

/* ==============================================================
   CONSTANTS
   ============================================================== */
const SECTORS = [
  "Frota","MKT","Comercial","Operacional","P√≥s-venda","Suporte",
  "Entrega/Devolu√ß√£o","CS","Qualidade","Pessoas/Cultura",
  "Oficina","Update","COO","Financeiro","Plus",
  "Cegonha","Kommo","Dashboard","Dunas","APN"
];

const COLORS = [
  {c:'var(--blue)',bg:'var(--blue-g)'},{c:'var(--green)',bg:'var(--green-g)'},
  {c:'var(--yellow)',bg:'var(--yellow-g)'},{c:'var(--orange)',bg:'var(--orange-g)'},
  {c:'var(--purple)',bg:'var(--purple-g)'},{c:'var(--cyan)',bg:'var(--cyan-g)'},
  {c:'var(--pink)',bg:'var(--pink-g)'},{c:'var(--red)',bg:'var(--red-g)'}
];

const STEP_ICONS = { action:'‚ñ∏', decision:'‚óÜ', 'end-ok':'‚úì', 'end-fail':'‚úó', subprocess:'‚äû', wait:'‚è≥' };
const STEP_LABELS = { action:'A√ß√£o', decision:'Decis√£o', 'end-ok':'Fim ‚úì', 'end-fail':'Fim ‚úó', subprocess:'Sub-processo', wait:'Espera' };

/* ==============================================================
   STATE
   ============================================================== */
let db = null;
let currentUser = null; // { name, role, sectors }
let currentSector = null;
let currentView = "macro"; // macro | micro
let currentMacroId = null;
let sectorData = {}; // { "Frota": { macro: [...] }, ... }
let unsubscribers = [];

/* ==============================================================
   FIREBASE INIT
   ============================================================== */
function initFirebase() {
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.firestore();
    return true;
  } catch (e) {
    console.error("Firebase init error:", e);
    return false;
  }
}

/* ==============================================================
   AUTH / LOGIN
   ============================================================== */
function doLogin() {
  const name = document.getElementById('loginName').value.trim();
  const code = document.getElementById('loginCode').value.trim().toLowerCase();
  const errEl = document.getElementById('loginError');

  if (!name) { errEl.textContent = "Digite seu nome."; errEl.style.display = 'block'; return; }
  if (!code) { errEl.textContent = "Digite o c√≥digo de acesso."; errEl.style.display = 'block'; return; }

  const access = ACCESS_CODES[code];
  if (!access) { errEl.textContent = "C√≥digo de acesso inv√°lido."; errEl.style.display = 'block'; return; }

  currentUser = { name, role: access.role, sectors: access.sectors, sectorName: access.name };

  // Save session
  sessionStorage.setItem('frc_user', JSON.stringify(currentUser));

  errEl.style.display = 'none';
  enterApp();
}

function doLogout() {
  sessionStorage.removeItem('frc_user');
  currentUser = null;
  unsubscribers.forEach(u => u());
  unsubscribers = [];
  document.getElementById('appScreen').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
}

function checkSession() {
  const saved = sessionStorage.getItem('frc_user');
  if (saved) {
    currentUser = JSON.parse(saved);
    enterApp();
    return true;
  }
  return false;
}

function enterApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appScreen').style.display = 'block';

  const badge = document.getElementById('userBadge');
  if (currentUser.role === 'ceo') {
    badge.className = 'user-badge ceo';
    badge.textContent = `üëë CEO ‚Äî ${currentUser.name}`;
  } else {
    badge.className = 'user-badge';
    badge.textContent = `${currentUser.sectorName} ‚Äî ${currentUser.name}`;
  }

  // Default to first allowed sector
  if (currentUser.sectors === 'all') {
    currentSector = SECTORS[0];
  } else {
    currentSector = currentUser.sectors[0];
  }

  renderSectorTabs();
  subscribeToSector(currentSector);
}

function canEdit(sector) {
  if (!currentUser) return false;
  if (currentUser.role === 'ceo') return true;
  if (currentUser.sectors === 'all') return true;
  return currentUser.sectors.includes(sector);
}

function canAccess(sector) {
  if (!currentUser) return false;
  if (currentUser.role === 'ceo' || currentUser.sectors === 'all') return true;
  return currentUser.sectors.includes(sector);
}

/* ==============================================================
   FIRESTORE CRUD
   ============================================================== */
function sectorDocId(sector) {
  return sector.replace(/[\/\s]/g, '_').toLowerCase();
}

function subscribeToSector(sector) {
  // Unsubscribe previous
  unsubscribers.forEach(u => u());
  unsubscribers = [];

  const docId = sectorDocId(sector);
  const unsub = db.collection('sectors').doc(docId).onSnapshot(doc => {
    if (doc.exists) {
      sectorData[sector] = doc.data();
    } else {
      sectorData[sector] = { macro: [] };
    }
    renderMain();
  }, err => {
    console.error("Firestore error:", err);
    toast("Erro ao carregar dados. Verifique a conex√£o.", "error");
  });

  unsubscribers.push(unsub);
}

async function saveSector(sector) {
  const docId = sectorDocId(sector);
  const data = sectorData[sector] || { macro: [] };
  data.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
  data.updatedBy = currentUser.name;

  try {
    await db.collection('sectors').doc(docId).set(data, { merge: true });
    toast("Salvo com sucesso!", "success");
  } catch (e) {
    console.error("Save error:", e);
    toast("Erro ao salvar. Verifique permiss√µes.", "error");
  }
}

/* ==============================================================
   RENDER: SECTOR TABS
   ============================================================== */
function renderSectorTabs() {
  const el = document.getElementById('sectorTabs');
  el.innerHTML = SECTORS.map(s => {
    const accessible = canAccess(s);
    const active = s === currentSector;
    return `<button class="stab ${active ? 'active' : ''} ${!accessible ? 'locked' : ''}" 
      onclick="${accessible ? `switchSector('${s}')` : ''}" 
      title="${!accessible ? 'Sem acesso a este setor' : s}">${s}</button>`;
  }).join('');
}

function switchSector(s) {
  if (!canAccess(s)) return;
  currentSector = s;
  currentView = "macro";
  currentMacroId = null;
  renderSectorTabs();
  subscribeToSector(s);
  updateBreadcrumb();
}

/* ==============================================================
   RENDER: MAIN
   ============================================================== */
function renderMain() {
  if (currentView === "micro" && currentMacroId) {
    renderMicro();
  } else {
    renderMacro();
  }
  updateBreadcrumb();
}

/* ==============================================================
   RENDER: MACRO VIEW
   ============================================================== */
function renderMacro() {
  const main = document.getElementById('mainContent');
  const data = sectorData[currentSector] || { macro: [] };
  const macros = data.macro || [];
  const editable = canEdit(currentSector);

  let h = `
    <div class="toolbar">
      <div class="toolbar-left">
        <h1>${currentSector}</h1>
        <p>Vis√£o macro ‚Äî clique num bloco para ver o fluxo micro detalhado</p>
      </div>
      <div class="toolbar-right">
        ${editable ? `<button class="tbtn primary" onclick="openAddMacro()">+ Novo Processo</button>` : ''}
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-card"><div class="sl">Processos</div><div class="sv">${macros.length}</div></div>
      <div class="stat-card"><div class="sl">Total etapas</div><div class="sv">${macros.reduce((a,m) => a + (m.micro?.length||0), 0)}</div></div>
      <div class="stat-card"><div class="sl">Penalidades</div><div class="sv">${macros.reduce((a,m) => a + (m.penalties?.length||0), 0)}</div></div>
      <div class="stat-card"><div class="sl">√öltima edi√ß√£o</div><div class="sv" style="font-size:0.8rem">${data.updatedBy || '‚Äî'}</div></div>
    </div>

    <div class="legend">
      <div class="leg"><div class="leg-d" style="border-color:var(--blue);background:var(--blue-g)"></div> A√ß√£o</div>
      <div class="leg"><div class="leg-d" style="border-color:var(--yellow);background:var(--yellow-g);border-radius:50%"></div> Decis√£o</div>
      <div class="leg"><div class="leg-d" style="border-color:var(--green);background:var(--green-g)"></div> Conclus√£o</div>
      <div class="leg"><div class="leg-d" style="border-color:var(--red);background:var(--red-g)"></div> Penalidade</div>
    </div>
  `;

  if (macros.length === 0) {
    h += `<div class="empty-state">
      <div class="ei">üìã</div>
      <h3>Nenhum processo definido</h3>
      <p>${editable ? 'Clique em "+ Novo Processo" para come√ßar a construir o fluxo deste setor.' : 'Aguarde o l√≠der deste setor definir os processos.'}</p>
    </div>`;
  } else {
    h += '<div class="macro-flow">';
    macros.forEach((m, i) => {
      const col = COLORS[(m.color || 0) % COLORS.length];
      const mc = m.micro?.length || 0;
      h += `
        <div class="mblock" style="animation-delay:${i*0.06}s" onclick="openMicro(${i})">
          <div class="mcard">
            ${editable ? `<div class="edit-btns" onclick="event.stopPropagation()">
              <button class="ebtn" onclick="openEditMacro(${i})">‚úé</button>
              <button class="ebtn del" onclick="deleteMacro(${i})">‚úï</button>
            </div>` : ''}
            <span class="mcount">${mc} etapas</span>
            <span class="mnum" style="background:${col.bg};color:${col.c}">MACRO ${i+1}</span>
            <h3>${esc(m.title)}</h3>
            <div class="mdesc">${esc(m.desc||'')}</div>
            <div class="mtags">
              <span class="mtag" style="background:var(--cyan-g);color:var(--cyan)">${esc(m.responsible||'A definir')}</span>
              <span class="mtag" style="background:var(--yellow-g);color:var(--yellow)">${esc(m.prazo||'A definir')}</span>
              ${m.penalties?.length ? `<span class="mtag" style="background:var(--red-g);color:var(--red)">${m.penalties.length} penalidades</span>` : ''}
            </div>
            <div class="mhint">Clique para ver micro ‚Üí</div>
          </div>
        </div>
      `;
      if (i < macros.length - 1) h += '<div class="marrow">‚Üí</div>';
    });
    h += '</div>';
  }

  if (editable && macros.length > 0) {
    h += `<div class="add-card" onclick="openAddMacro()"><div class="ai">+</div><p>Adicionar processo macro</p></div>`;
  }

  main.innerHTML = h;
}

/* ==============================================================
   RENDER: MICRO VIEW
   ============================================================== */
function openMicro(idx) {
  currentView = "micro";
  currentMacroId = idx;
  renderMain();
}

function goMacro() {
  currentView = "macro";
  currentMacroId = null;
  renderMain();
}

function renderMicro() {
  const main = document.getElementById('mainContent');
  const data = sectorData[currentSector] || { macro: [] };
  const macro = data.macro?.[currentMacroId];
  if (!macro) { goMacro(); return; }

  const editable = canEdit(currentSector);
  const col = COLORS[(macro.color||0) % COLORS.length];
  const steps = macro.micro || [];

  let h = `
    <button class="micro-back" onclick="goMacro()">‚Üê Voltar ao Macro</button>

    <div class="micro-head">
      <div>
        <h2>${esc(macro.title)}</h2>
        <div class="msub">${esc(macro.desc||'')}</div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:flex-start;">
        <span class="mtag" style="background:var(--cyan-g);color:var(--cyan);font-size:0.7rem;padding:5px 11px;border-radius:7px">${esc(macro.responsible||'')}</span>
        <span class="mtag" style="background:var(--yellow-g);color:var(--yellow);font-size:0.7rem;padding:5px 11px;border-radius:7px">${esc(macro.prazo||'')}</span>
        ${editable ? `<button class="tbtn primary" onclick="openAddStep()" style="font-size:0.7rem;padding:5px 11px">+ Etapa</button>` : ''}
      </div>
    </div>

    <div class="legend">
      <div class="leg"><div class="leg-d" style="border-color:var(--blue);background:var(--blue-g)"></div> A√ß√£o</div>
      <div class="leg"><div class="leg-d" style="border-color:var(--yellow);background:var(--yellow-g);border-radius:50%"></div> Decis√£o</div>
      <div class="leg"><div class="leg-d" style="border-color:var(--green);background:var(--green-g)"></div> Conclus√£o</div>
      <div class="leg"><div class="leg-d" style="border-color:var(--orange);background:var(--orange-g)"></div> Espera</div>
    </div>

    <div class="micro-flow">
  `;

  steps.forEach((step, i) => {
    const isLast = i === steps.length - 1;
    const dt = step.type || 'action';

    let tags = '';
    if (step.tags?.length) {
      tags = '<div class="stags">' + step.tags.map(t => `<span class="stg ${t.t||'resp'}">${esc(t.l)}</span>`).join('') + '</div>';
    }

    let br = '';
    if (step.branches) {
      br = `<div class="branches">
        <div class="bbx yes"><div class="blbl">‚úÖ SIM</div><p>${esc(step.branches.yes||'')}</p></div>
        <div class="bbx no"><div class="blbl">‚ùå N√ÉO</div><p>${esc(step.branches.no||'')}</p></div>
      </div>`;
    }

    h += `
      <div class="mstep" style="animation-delay:${i*0.05}s">
        <div class="mtimeline">
          <div class="mdot ${dt}">${STEP_ICONS[dt]||i+1}</div>
          ${!isLast ? '<div class="mline"></div>' : ''}
        </div>
        <div class="scard">
          ${editable ? `<div class="edit-btns">
            ${i > 0 ? `<button class="ebtn" onclick="moveStep(${i},-1)">‚Üë</button>` : ''}
            ${i < steps.length-1 ? `<button class="ebtn" onclick="moveStep(${i},1)">‚Üì</button>` : ''}
            <button class="ebtn" onclick="openEditStep(${i})">‚úé</button>
            <button class="ebtn del" onclick="deleteStep(${i})">‚úï</button>
          </div>` : ''}
          <h4>${esc(step.title)}</h4>
          <div class="sd">${esc(step.desc||'')}</div>
          ${tags}
          ${br}
        </div>
      </div>
    `;
  });

  h += '</div>';

  // Penalties
  if (macro.penalties?.length) {
    h += `<div class="penalty-section">
      <h5>‚ö† PENALIDADES DESTE PROCESSO ${editable ? `<button class="ebtn" onclick="openEditPenalties()" style="margin-left:8px">‚úé Editar</button>` : ''}</h5>
      <ul>${macro.penalties.map(p => `<li>${esc(p)}</li>`).join('')}</ul>
    </div>`;
  } else if (editable) {
    h += `<div class="add-card" onclick="openEditPenalties()" style="max-width:780px;margin-top:16px;padding:20px">
      <p>+ Adicionar penalidades a este processo</p>
    </div>`;
  }

  main.innerHTML = h;
}

/* ==============================================================
   BREADCRUMB
   ============================================================== */
function updateBreadcrumb() {
  const bc = document.getElementById('breadcrumb');
  if (currentView === "micro" && currentMacroId !== null) {
    const macro = sectorData[currentSector]?.macro?.[currentMacroId];
    bc.innerHTML = `
      <span onclick="goMacro()">${currentSector}</span>
      <span class="sep">‚Ä∫</span>
      <span onclick="goMacro()">Macro</span>
      <span class="sep">‚Ä∫</span>
      <span class="cur">${esc(macro?.title || 'Micro')}</span>
    `;
  } else {
    bc.innerHTML = `<span class="cur">${currentSector} ‚Äî Fluxo Macro</span>`;
  }
}

/* ==============================================================
   MODALS: MACRO CRUD
   ============================================================== */
function openAddMacro() {
  openMacroModal(null);
}

function openEditMacro(idx) {
  openMacroModal(idx);
}

function openMacroModal(idx) {
  const isEdit = idx !== null;
  const macro = isEdit ? sectorData[currentSector]?.macro?.[idx] : {};
  const m = document.getElementById('modalContent');

  m.innerHTML = `
    <h2>${isEdit ? 'Editar' : 'Novo'} Processo Macro ‚Äî ${currentSector}</h2>
    <div class="fg">
      <label>Nome do processo *</label>
      <input type="text" id="mTitle" value="${esc(macro.title||'')}" placeholder="Ex: Aquisi√ß√£o de Ve√≠culo">
    </div>
    <div class="fg">
      <label>Descri√ß√£o</label>
      <textarea id="mDesc" placeholder="O que este processo abrange...">${esc(macro.desc||'')}</textarea>
    </div>
    <div class="fg-row">
      <div class="fg">
        <label>Respons√°vel principal</label>
        <input type="text" id="mResp" value="${esc(macro.responsible||'')}" placeholder="Ex: Gestor de Frota">
      </div>
      <div class="fg">
        <label>Prazo geral</label>
        <input type="text" id="mPrazo" value="${esc(macro.prazo||'')}" placeholder="Ex: 7-15 dias">
      </div>
    </div>
    <div class="fg">
      <label>Cor do bloco</label>
      <select id="mColor">
        ${['Azul','Verde','Amarelo','Laranja','Roxo','Ciano','Rosa','Vermelho'].map((c,i) =>
          `<option value="${i}" ${(macro.color||0)===i?'selected':''}>${c}</option>`
        ).join('')}
      </select>
    </div>
    <div class="form-actions">
      <button class="btn btn-cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-save" onclick="saveMacroModal(${idx})">${isEdit ? 'Salvar' : 'Criar Processo'}</button>
    </div>
  `;

  showModal();
}

async function saveMacroModal(idx) {
  const title = document.getElementById('mTitle').value.trim();
  if (!title) { alert('Nome √© obrigat√≥rio'); return; }

  const obj = {
    title,
    desc: document.getElementById('mDesc').value.trim(),
    responsible: document.getElementById('mResp').value.trim() || 'A definir',
    prazo: document.getElementById('mPrazo').value.trim() || 'A definir',
    color: parseInt(document.getElementById('mColor').value)
  };

  if (!sectorData[currentSector]) sectorData[currentSector] = { macro: [] };
  if (!sectorData[currentSector].macro) sectorData[currentSector].macro = [];

  if (idx !== null) {
    // Edit existing
    Object.assign(sectorData[currentSector].macro[idx], obj);
  } else {
    // New ‚Äî add with default micro steps
    obj.micro = [
      { type:"action", title:"Etapa 1 ‚Äî Definir", desc:"Descrever a primeira etapa.", tags:[{l:obj.responsible,t:"resp"}] },
      { type:"decision", title:"Checkpoint ‚Äî Entregou?", desc:"Verificar entrega no prazo.", branches:{yes:"Prosseguir.",no:"Plano de a√ß√£o corretivo."} },
      { type:"end-ok", title:"Processo conclu√≠do", desc:"Resultado registrado e validado." }
    ];
    obj.penalties = ["Definir penalidade para atraso", "Definir penalidade para reincid√™ncia"];
    sectorData[currentSector].macro.push(obj);
  }

  closeModal();
  await saveSector(currentSector);
}

async function deleteMacro(idx) {
  if (!confirm(`Deletar o processo "${sectorData[currentSector].macro[idx].title}"? Esta a√ß√£o n√£o pode ser desfeita.`)) return;
  sectorData[currentSector].macro.splice(idx, 1);
  await saveSector(currentSector);
}

/* ==============================================================
   MODALS: MICRO STEP CRUD
   ============================================================== */
function openAddStep() {
  openStepModal(null);
}

function openEditStep(idx) {
  openStepModal(idx);
}

function openStepModal(idx) {
  const macro = sectorData[currentSector]?.macro?.[currentMacroId];
  if (!macro) return;

  const isEdit = idx !== null;
  const step = isEdit ? macro.micro?.[idx] || {} : {};

  const tagsStr = (step.tags || []).map(t => `${t.l}|${t.t}`).join('\n');
  const isDecision = (step.type || 'action') === 'decision';

  const m = document.getElementById('modalContent');
  m.innerHTML = `
    <h2>${isEdit ? 'Editar' : 'Nova'} Etapa Micro</h2>
    <div class="fg-row">
      <div class="fg">
        <label>Tipo de etapa *</label>
        <select id="sType" onchange="toggleBranches()">
          ${Object.entries(STEP_LABELS).map(([k,v]) =>
            `<option value="${k}" ${(step.type||'action')===k?'selected':''}>${v}</option>`
          ).join('')}
        </select>
      </div>
      <div class="fg">
        <label>T√≠tulo *</label>
        <input type="text" id="sTitle" value="${esc(step.title||'')}" placeholder="Ex: Verificar disponibilidade">
      </div>
    </div>
    <div class="fg">
      <label>Descri√ß√£o</label>
      <textarea id="sDesc" placeholder="Detalhe o que deve ser feito nesta etapa...">${esc(step.desc||'')}</textarea>
    </div>
    <div class="fg">
      <label>Tags (uma por linha: texto|tipo) ‚Äî tipos: resp, prazo, sistema, meta</label>
      <textarea id="sTags" placeholder="Ex:\nGestor Frota|resp\n24h|prazo\nDunas|sistema" style="min-height:60px">${tagsStr}</textarea>
    </div>
    <div id="branchFields" style="display:${isDecision?'block':'none'}">
      <div class="fg">
        <label>SIM ‚Äî O que acontece se entregou</label>
        <textarea id="sYes" style="min-height:50px">${esc(step.branches?.yes||'')}</textarea>
      </div>
      <div class="fg">
        <label>N√ÉO ‚Äî O que acontece se n√£o entregou</label>
        <textarea id="sNo" style="min-height:50px">${esc(step.branches?.no||'')}</textarea>
      </div>
    </div>
    <div class="form-actions">
      <button class="btn btn-cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-save" onclick="saveStepModal(${idx})">Salvar Etapa</button>
    </div>
  `;
  showModal();
}

function toggleBranches() {
  const type = document.getElementById('sType').value;
  document.getElementById('branchFields').style.display = type === 'decision' ? 'block' : 'none';
}

async function saveStepModal(idx) {
  const title = document.getElementById('sTitle').value.trim();
  if (!title) { alert('T√≠tulo √© obrigat√≥rio'); return; }

  const type = document.getElementById('sType').value;
  const obj = {
    type,
    title,
    desc: document.getElementById('sDesc').value.trim()
  };

  // Parse tags
  const tagsRaw = document.getElementById('sTags').value.trim();
  if (tagsRaw) {
    obj.tags = tagsRaw.split('\n').filter(l => l.trim()).map(l => {
      const [label, t] = l.split('|');
      return { l: label?.trim() || '', t: t?.trim() || 'resp' };
    });
  }

  // Branches
  if (type === 'decision') {
    obj.branches = {
      yes: document.getElementById('sYes').value.trim(),
      no: document.getElementById('sNo').value.trim()
    };
  }

  const macro = sectorData[currentSector].macro[currentMacroId];
  if (!macro.micro) macro.micro = [];

  if (idx !== null) {
    macro.micro[idx] = obj;
  } else {
    macro.micro.push(obj);
  }

  closeModal();
  await saveSector(currentSector);
}

async function deleteStep(idx) {
  if (!confirm('Deletar esta etapa?')) return;
  sectorData[currentSector].macro[currentMacroId].micro.splice(idx, 1);
  await saveSector(currentSector);
}

async function moveStep(idx, dir) {
  const steps = sectorData[currentSector].macro[currentMacroId].micro;
  const newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= steps.length) return;
  [steps[idx], steps[newIdx]] = [steps[newIdx], steps[idx]];
  await saveSector(currentSector);
}

/* ==============================================================
   MODALS: PENALTIES
   ============================================================== */
function openEditPenalties() {
  const macro = sectorData[currentSector]?.macro?.[currentMacroId];
  if (!macro) return;

  const pens = (macro.penalties || []).join('\n');
  const m = document.getElementById('modalContent');
  m.innerHTML = `
    <h2>‚ö† Penalidades ‚Äî ${esc(macro.title)}</h2>
    <div class="fg">
      <label>Uma penalidade por linha</label>
      <textarea id="pText" style="min-height:120px" placeholder="Ex:\nAtraso > 5 dias: advert√™ncia verbal\nReincid√™ncia: advert√™ncia escrita">${pens}</textarea>
    </div>
    <div class="form-actions">
      <button class="btn btn-cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-save" onclick="savePenalties()">Salvar</button>
    </div>
  `;
  showModal();
}

async function savePenalties() {
  const text = document.getElementById('pText').value.trim();
  sectorData[currentSector].macro[currentMacroId].penalties = text ? text.split('\n').filter(l => l.trim()) : [];
  closeModal();
  await saveSector(currentSector);
}

/* ==============================================================
   MODAL HELPERS
   ============================================================== */
function showModal() { document.getElementById('modalOverlay').classList.add('active'); }
function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

/* ==============================================================
   UTILS
   ============================================================== */
function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function toast(msg, type = 'info') {
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

/* ==============================================================
   SEED: Populate Frota example data if empty
   ============================================================== */
async function seedFrotaIfEmpty() {
  const docId = sectorDocId("Frota");
  const doc = await db.collection('sectors').doc(docId).get();

  if (!doc.exists) {
    const frotaData = {
      macro: [
        {
          title: "Aquisi√ß√£o de Ve√≠culo",
          desc: "Compra, financiamento, documenta√ß√£o e prepara√ß√£o do ve√≠culo novo para a frota.",
          color: 0, responsible: "Gestor de Frota", prazo: "7-15 dias",
          micro: [
            {type:"action",title:"Identificar necessidade de frota",desc:"Analisar demanda por categoria (Economy, SUV, Tesla, Mustang, Ram) vs. disponibilidade atual.",tags:[{l:"Gestor Frota",t:"resp"},{l:"Dashboard",t:"sistema"}]},
            {type:"decision",title:"Or√ßamento aprovado?",desc:"Verificar budget dispon√≠vel conforme plano de expans√£o.",branches:{yes:"Prosseguir com cota√ß√£o.",no:"Solicitar aprova√ß√£o ao CEO com justificativa de ROI."}},
            {type:"action",title:"Cota√ß√£o e negocia√ß√£o",desc:"Cotar em pelo menos 3 fornecedores. Negociar pre√ßo e condi√ß√µes.",tags:[{l:"Gestor Frota",t:"resp"},{l:"5 dias √∫teis",t:"prazo"}]},
            {type:"action",title:"Documenta√ß√£o e registro",desc:"Registrar ve√≠culo, fazer seguro, configurar no Dunas, adicionar SunPass.",tags:[{l:"Administrativo",t:"resp"},{l:"Dunas",t:"sistema"},{l:"3 dias",t:"prazo"}]},
            {type:"action",title:"Prepara√ß√£o do ve√≠culo",desc:"Inspe√ß√£o, lavagem, acess√≥rios, fotos para cat√°logo.",tags:[{l:"Oficina",t:"resp"},{l:"2 dias",t:"prazo"}]},
            {type:"end-ok",title:"Ve√≠culo dispon√≠vel para loca√ß√£o",desc:"100% pronto, cadastrado e dispon√≠vel para reserva."}
          ],
          penalties:["Atraso > 5 dias: advert√™ncia verbal","Sem documenta√ß√£o completa em opera√ß√£o: advert√™ncia escrita","Sem inspe√ß√£o: suspens√£o + retreinamento"]
        },
        {
          title: "Manuten√ß√£o Preventiva",
          desc: "Controle de revis√µes peri√≥dicas, troca de √≥leo, pneus, freios e itens de desgaste.",
          color: 1, responsible: "Coord. Oficina", prazo: "Conforme km/tempo",
          micro: [
            {type:"action",title:"Alerta de manuten√ß√£o",desc:"Dunas gera alerta autom√°tico baseado em km ou tempo.",tags:[{l:"Dunas",t:"sistema"},{l:"Autom√°tico",t:"prazo"}]},
            {type:"action",title:"Agendar manuten√ß√£o",desc:"Verificar disponibilidade e agendar sem impactar reservas.",tags:[{l:"Coord. Oficina",t:"resp"},{l:"24h ap√≥s alerta",t:"prazo"}]},
            {type:"action",title:"Executar manuten√ß√£o",desc:"Realizar servi√ßos conforme checklist. Registrar no sistema.",tags:[{l:"Mec√¢nico",t:"resp"},{l:"Dunas",t:"sistema"}]},
            {type:"decision",title:"Aprovado na inspe√ß√£o?",branches:{yes:"Liberar ve√≠culo. Atualizar status.",no:"Retrabalho imediato."}},
            {type:"end-ok",title:"Ve√≠culo liberado",desc:"Manuten√ß√£o registrada, pr√≥ximo alerta programado."}
          ],
          penalties:["N√£o agendada em 24h: advert√™ncia verbal","Ve√≠culo com manuten√ß√£o vencida em opera√ß√£o: advert√™ncia escrita","Reincid√™ncia: suspens√£o"]
        },
        {
          title: "Gest√£o de Sinistros",
          desc: "Processo de dano: comunica√ß√£o, documenta√ß√£o, reparo e retorno √† opera√ß√£o.",
          color: 3, responsible: "Gestor Frota + P√≥s-venda", prazo: "Conforme gravidade",
          micro: [
            {type:"action",title:"Receber comunica√ß√£o do sinistro",desc:"Registrar imediatamente no Kommo + Dunas com fotos.",tags:[{l:"P√≥s-venda",t:"resp"},{l:"Kommo",t:"sistema"},{l:"Imediato",t:"prazo"}]},
            {type:"action",title:"Classificar gravidade",desc:"Avaliar: dano est√©tico, mec√¢nico ou perda total.",tags:[{l:"Gestor Frota",t:"resp"}]},
            {type:"decision",title:"Pode continuar operando?",branches:{yes:"Agendar reparo para janela sem reserva.",no:"Retirar de opera√ß√£o. Acionar seguro. Ve√≠culo substituto."}},
            {type:"action",title:"Acionar seguro / or√ßar reparo",desc:"Abrir sinistro ou cotar em oficinas parceiras.",tags:[{l:"Administrativo",t:"resp"},{l:"48h",t:"prazo"}]},
            {type:"action",title:"Executar e inspecionar reparo",desc:"Acompanhar reparo, verificar qualidade, test drive.",tags:[{l:"Coord. Oficina",t:"resp"}]},
            {type:"end-ok",title:"Ve√≠culo retorna √† opera√ß√£o",desc:"Sinistro finalizado, custos apurados."}
          ],
          penalties:["N√£o registrado em 24h: advert√™ncia escrita","Dano mec√¢nico mantido sem autoriza√ß√£o: suspens√£o imediata","Seguro fora do prazo: respons√°vel assume custo"]
        },
        {
          title: "Controle de Disponibilidade",
          desc: "Gest√£o di√°ria: dispon√≠veis, alugados, manuten√ß√£o, tr√¢nsito entre pra√ßas.",
          color: 4, responsible: "Gestor de Frota", prazo: "Di√°rio",
          micro: [
            {type:"action",title:"Atualizar status da frota",desc:"Todo dia 8h: dispon√≠veis, alugados, manuten√ß√£o, tr√¢nsito (ORL/MIA/FLL).",tags:[{l:"Gestor Frota",t:"resp"},{l:"Dashboard",t:"sistema"},{l:"8h di√°rio",t:"prazo"}]},
            {type:"action",title:"Verificar devolu√ß√µes do dia",desc:"Cruzar devolu√ß√µes com reservas pendentes.",tags:[{l:"Operacional",t:"resp"},{l:"Dunas",t:"sistema"}]},
            {type:"decision",title:"Demanda > Disponibilidade?",branches:{yes:"Acionar Cegonha ou aluguel emergencial.",no:"Opera√ß√£o normal. Registrar ociosidade."}},
            {type:"action",title:"Relat√≥rio semanal",desc:"Taxa de ocupa√ß√£o por pra√ßa e categoria.",tags:[{l:"Gestor Frota",t:"resp"},{l:"Sexta-feira",t:"prazo"}]},
            {type:"end-ok",title:"Frota otimizada",desc:"Utiliza√ß√£o maximizada, zero reserva sem ve√≠culo."}
          ],
          penalties:["Dashboard n√£o atualizado at√© 8h: advert√™ncia verbal","Cliente sem ve√≠culo por falta de controle: advert√™ncia escrita","Reincid√™ncia 30 dias: reuni√£o de performance"]
        },
        {
          title: "Desativa√ß√£o / Venda",
          desc: "Ve√≠culo no fim do ciclo: an√°lise, prepara√ß√£o, venda e baixa no sistema.",
          color: 7, responsible: "Gestor Frota + Financeiro", prazo: "Conforme ciclo",
          micro: [
            {type:"action",title:"Identificar ve√≠culos fim de ciclo",desc:"An√°lise mensal: km, custo manuten√ß√£o, valor revenda.",tags:[{l:"Gestor Frota",t:"resp"},{l:"Dashboard",t:"sistema"},{l:"Mensal",t:"prazo"}]},
            {type:"decision",title:"Custo manter > Benef√≠cio?",branches:{yes:"Iniciar desativa√ß√£o e venda.",no:"Manter. Pr√≥xima avalia√ß√£o em 30 dias."}},
            {type:"action",title:"Preparar para venda",desc:"Manuten√ß√£o cosm√©tica, limpeza, documenta√ß√£o, precifica√ß√£o.",tags:[{l:"Oficina + Financeiro",t:"resp"},{l:"5 dias",t:"prazo"}]},
            {type:"action",title:"Anunciar e vender",desc:"Publicar, negociar, transferir documenta√ß√£o.",tags:[{l:"Administrativo",t:"resp"}]},
            {type:"action",title:"Baixa no sistema",desc:"Remover do Dunas, atualizar Dashboard, registrar receita.",tags:[{l:"Gestor Frota",t:"resp"},{l:"Dunas",t:"sistema"}]},
            {type:"end-ok",title:"Ve√≠culo desativado",desc:"Receita registrada, frota atualizada."}
          ],
          penalties:["Custo negativo sem justificativa: advert√™ncia escrita","Baixa n√£o realizada em 48h: advert√™ncia verbal"]
        }
      ]
    };

    await db.collection('sectors').doc(docId).set(frotaData);
    console.log("Frota seed data created!");
  }
}

/* ==============================================================
   INIT
   ============================================================== */
window.addEventListener('DOMContentLoaded', () => {
  const ok = initFirebase();

  if (!ok || FIREBASE_CONFIG.apiKey.startsWith("SUA_")) {
    // Demo mode without Firebase
    document.getElementById('loginScreen').innerHTML = `
      <div class="login-box">
        <div class="login-logo">FLORIDA RENTAL CAR</div>
        <div class="login-sub">Sistema de Fluxogramas de Processos</div>
        <h2 style="color:var(--yellow)">‚ö† Firebase n√£o configurado</h2>
        <p style="color:var(--text2);font-size:0.85rem;line-height:1.6;margin-bottom:20px">
          Para ativar o sistema, siga o guia de setup:<br>
          1. Crie um projeto no <a href="https://console.firebase.google.com" target="_blank" style="color:var(--blue)">Firebase Console</a><br>
          2. Copie as credenciais para o arquivo HTML<br>
          3. Configure as regras do Firestore<br><br>
          Veja o arquivo <strong>SETUP-GUIDE.md</strong> para instru√ß√µes completas.
        </p>
        <button class="login-btn" onclick="startDemo()" style="background:var(--yellow);color:#1a1a1a">Entrar em modo DEMO (sem salvar)</button>
      </div>
    `;
    return;
  }

  // Try restore session
  if (!checkSession()) {
    // Show login
  }

  // Seed Frota data
  seedFrotaIfEmpty();
});

// Demo mode (no Firebase)
function startDemo() {
  // Override save to be no-op
  window._demoMode = true;
  db = {
    collection: () => ({
      doc: () => ({
        set: async () => {},
        get: async () => ({ exists: false }),
        onSnapshot: (cb) => { cb({ exists: false, data: () => null }); return () => {}; }
      })
    })
  };

  // Load demo data directly
  sectorData["Frota"] = {
    macro: [
      { title:"Aquisi√ß√£o de Ve√≠culo", desc:"Compra e prepara√ß√£o de ve√≠culos.", color:0, responsible:"Gestor de Frota", prazo:"7-15 dias",
        micro: [
          {type:"action",title:"Identificar necessidade",desc:"Analisar demanda por categoria.",tags:[{l:"Gestor Frota",t:"resp"}]},
          {type:"decision",title:"Or√ßamento aprovado?",branches:{yes:"Prosseguir.",no:"Solicitar aprova√ß√£o CEO."}},
          {type:"end-ok",title:"Ve√≠culo dispon√≠vel",desc:"Pronto para loca√ß√£o."}
        ],
        penalties:["Atraso > 5 dias: advert√™ncia verbal"]
      }
    ]
  };

  currentUser = { name: "Demo", role: "ceo", sectors: "all", sectorName: "CEO" };
  enterApp();
  renderMain();
  toast("Modo DEMO ‚Äî dados n√£o ser√£o salvos", "info");
}
</script>

</body>
</html>
